FROM mcr.microsoft.com/dotnet/sdk:8.0

# Set environment variables
ENV DOTNET_SKIP_FIRST_TIME_EXPERIENCE=1
ENV DOTNET_CLI_TELEMETRY_OPTOUT=1
ENV DOTNET_NOLOGO=1

# Install additional tools
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# Install global tools
RUN dotnet tool install --global dotnet-reportgenerator-globaltool
RUN dotnet tool install --global dotnet-coverage

# Create test results directory
RUN mkdir -p /workspace/test-results/dotnet

# Set working directory
WORKDIR /workspace

# Copy test project files
COPY tests/Nexo.Feature.Pipeline.Tests/ ./tests/Nexo.Feature.Pipeline.Tests/
COPY src/ ./src/
COPY global.json ./

# Create entrypoint script
RUN echo '#!/bin/bash\n\
echo "Running .NET 8.0 tests..."\n\
dotnet restore tests/Nexo.Feature.Pipeline.Tests/Nexo.Feature.Pipeline.Tests.csproj\n\
dotnet test tests/Nexo.Feature.Pipeline.Tests/Nexo.Feature.Pipeline.Tests.csproj \\\n\
  --filter "RuntimeFactAttribute&SupportedRuntimes=DotNet" \\\n\
  --logger "console;verbosity=detailed" \\\n\
  --results-directory /workspace/test-results/dotnet \\\n\
  --collect:"XPlat Code Coverage" \\\n\
  --settings /workspace/tests/Nexo.Feature.Pipeline.Tests/Docker/coverlet.runsettings\n\
echo "Tests completed for .NET 8.0"\n\
' > /entrypoint.sh && chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"] 